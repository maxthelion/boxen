# Octopoid v2 Migration: Boxen

**Status:** Idea
**Captured:** 2026-02-20

## Raw

> "there's a new version of octopoid in feature/client-server-architecture. It significantly changes the agent model. We need QA gatekeeper running after the sanity-checker, and human review stages. Remove current implementation and start fresh."

## What's on the Branch

`feature/client-server-architecture` in the octopoid submodule is far ahead of our local checkout (186+ commits behind main, branch has 150+ commits beyond that). The system already has:

- **Flow engine** (`orchestrator/flow.py`) — declarative YAML state machines with conditions, agents, on_fail targets
- **Step registry** (`orchestrator/steps.py`) — `push_branch`, `run_tests`, `create_pr`, `merge_pr`, `post_review_comment`
- **Blueprint agent model** — agents.yaml uses dict format with `spawn_mode`, `claim_from`, `agent_dir`, `max_instances`
- **Agent directories** — `.octopoid/agents/gatekeeper/` and `.octopoid/agents/implementer/` with `prompt.md`, `instructions.md`, `scripts/`
- **Gatekeeper scripts** — `run-tests`, `check-scope`, `check-debug-code`, `diff-stats`, `post-review`
- **Pool model** — blueprint-based agent spawning with per-blueprint PID tracking
- **Python SDK** with scope support (`scope` auto-injected into API requests)
- **Server submodule** extracted to standalone repo, extensible queue names
- **Pure-function agents** — scheduler owns branch/PR lifecycle, agents just write `result.json`
- **Flow engine owns transitions** — steps (`push_branch`, `run_tests`, etc.) are pre-transition side effects. The engine moves tasks to the target queue automatically after steps complete — no `submit_to_server` step needed
- **Project flows** — child tasks on shared branches, project-level PR creation
- **Textual dashboard** — full TUI rewrite with kanban, task detail, drafts, agents tabs

The existing `default.yaml` flow is: `incoming -> claimed -> provisional -> done` (single gatekeeper). We need to extend it.

## What the Migration Needs

Per `OCTOPOID_MIGRATION.md`:

### 1. Update submodule
Pull `feature/client-server-architecture` (or main, if merged by then).

### 2. Update config.yaml
Add `cluster: boxen`, `scope: boxen`, hooks for `before_submit` and `before_merge`.

### 3. Update agents.yaml
Already mostly done on the branch. Need to add the QA gatekeeper blueprint:

```yaml
qa-gatekeeper:
  role: gatekeeper
  spawn_mode: scripts
  claim_from: sanity_approved
  interval_seconds: 120
  max_turns: 80
  model: sonnet
  agent_dir: .octopoid/agents/qa-gatekeeper
  max_instances: 1
```

### 4. Extend the flow
Change `default.yaml` from 3-stage to 5-stage:

```yaml
"provisional -> sanity_approved":    # sanity-check gatekeeper
"sanity_approved -> human_review":   # QA gatekeeper
"human_review -> done":              # human approval
```

### 5. Create QA gatekeeper agent directory
Port from `.orchestrator/prompts/gatekeeper-qa.md`. Needs Playwright MCP access.

### 6. Retire v1

## Issues I Foresee

### A. `hooks` config doesn't exist yet
The migration doc specifies `hooks.before_submit` and `hooks.before_merge` in config.yaml. The branch has a hooks system (`orchestrator/hooks.py` or similar) but I haven't confirmed it reads from config.yaml in this format. The step registry (`steps.py`) may already cover what hooks would do — the `runs:` lists in flow transitions execute `push_branch`, `run_tests`, `create_pr`, `merge_pr`. Hooks might be redundant.

### B. QA gatekeeper needs Playwright MCP
The existing gatekeeper is a pure-function agent that writes `result.json`. The QA gatekeeper needs Playwright MCP tools to navigate preview URLs, take screenshots, and validate visual output. This means the agent invocation needs `--allowedTools` to include `mcp__playwright__*`, and the MCP server needs to be configured in the worktree environment. Need to verify the scheduler's agent spawning supports this.

### C. Human review stage has no UI yet
The flow supports `type: manual` conditions, but there's no dashboard UI for humans to approve/reject tasks in `human_review`. The Textual dashboard would need a "Human Review" column or action. Alternatively, this could be done via CLI (`octopoid approve <task-id>`).

### D. Submodule is 186 commits behind
Our local `orchestrator/` checkout is on `main` but 186 commits behind `origin/main`. The feature branch is even further ahead. Updating the submodule will be a big jump. Need to check if any of our local customizations (`.orchestrator/scripts/`, `.orchestrator/prompts/`) conflict with the new structure.

### E. v1 retirement — what about in-flight tasks?
If we have tasks in the v1 queue when we switch, they'll be orphaned. Need to either drain the queue first or migrate task files to the v2 format.

### F. Agent directory naming mismatch
The migration doc says gatekeeper directories should have `CLAUDE.md`, but the existing agents on the branch use `prompt.md` + `instructions.md`. Minor, but need to follow whichever convention the scheduler actually reads.

## Open Questions

- Is `feature/client-server-architecture` going to be merged to main in the octopoid repo, or should we point the submodule at the branch directly?
- Do we need the `hooks` config, or are flow `runs:` steps sufficient?
- How do we configure Playwright MCP for the QA gatekeeper agent environment?
- Is CLI-based human approval good enough, or do we need dashboard UI first?

## Possible Next Steps

1. Update the submodule to the latest branch/main
2. Write the extended `default.yaml` flow with 5 stages
3. Create `.octopoid/agents/qa-gatekeeper/` directory with Playwright instructions
4. Test the sanity-check gatekeeper end-to-end (it already exists on the branch)
5. Add `human_review` manual approval via CLI
6. Pause v1 agents, retire `.orchestrator/` system
