# Plan: Migrate from face-* IDs to UUIDs

## Summary

Standardize on engine-generated UUIDs for all panel identification, deprecating the legacy `face-front`, `face-back` format.

---

## Current State

The codebase uses two ID formats for face panels:

1. **Legacy format**: `face-front`, `face-back`, `subasm-{id}-face-{faceId}`
2. **Engine UUIDs**: Generated by `FacePanelNode` (e.g., `550e8400-e29b-41d4-a716-446655440000`)

### Where Legacy Format is Used

| Location | Usage |
|----------|-------|
| `types.ts` | `MAIN_FACE_PANEL_IDS` constant |
| `useBoxStore.ts` | Visibility system (`hiddenFaceIds`, `isolatedPanelId`) |
| `useBoxStore.ts` | `setIsolatedVoid`, `setIsolatedSubAssembly`, `setIsolatedPanel` |
| `BoxTree.tsx` | Tree node IDs for faces |
| `PanelPathRenderer.tsx` | Visibility check (legacy fallback) |
| `BaseAssembly.ts` | Edge extensions keyed by `face-{faceId}` |
| `panelGenerator.ts` | Panel ID generation |
| `urlState.ts` | URL serialization of edge extensions |
| Various tests | Test data using `face-front`, etc. |

### Why UUIDs are Better

1. **Consistency**: All panels (faces, dividers) use the same ID system
2. **Uniqueness**: No collisions across scene clones (preview/commit)
3. **Simpler code**: No special-casing for face panels vs dividers
4. **Future-proof**: Works with multi-assembly scenes

---

## Migration Strategy

### Phase 1: Add UUID Lookup Helpers

Create helpers to get UUIDs from the engine:

```typescript
// src/engine/utils/panelLookup.ts

/**
 * Get the engine UUID for a main assembly face panel
 */
export function getFacePanelId(faceId: FaceId): string | null {
  const engine = getEngine();
  const panels = engine.generatePanelsFromNodes().panels;
  const panel = panels.find(p =>
    p.source.type === 'face' &&
    p.source.faceId === faceId &&
    !p.source.subAssemblyId
  );
  return panel?.id ?? null;
}

/**
 * Get the engine UUID for a sub-assembly face panel
 */
export function getSubAssemblyFacePanelId(
  subAssemblyId: string,
  faceId: FaceId
): string | null {
  const engine = getEngine();
  const panels = engine.generatePanelsFromNodes().panels;
  const panel = panels.find(p =>
    p.source.type === 'face' &&
    p.source.faceId === faceId &&
    p.source.subAssemblyId === subAssemblyId
  );
  return panel?.id ?? null;
}

/**
 * Build a map from faceId to UUID for all face panels
 */
export function buildFacePanelIdMap(): Map<FaceId, string> {
  const engine = getEngine();
  const panels = engine.generatePanelsFromNodes().panels;
  const map = new Map<FaceId, string>();

  for (const panel of panels) {
    if (panel.source.type === 'face' &&
        panel.source.faceId &&
        !panel.source.subAssemblyId) {
      map.set(panel.source.faceId, panel.id);
    }
  }
  return map;
}
```

### Phase 2: Update Visibility System

Modify `useBoxStore.ts` to use UUIDs:

```typescript
// Before (using MAIN_FACE_PANEL_IDS)
for (const faceId of MAIN_FACE_PANEL_IDS) {
  if (faceId !== panelId && !state.hiddenFaceIds.has(faceId)) {
    newHiddenFaceIds.add(faceId);
  }
}

// After (using engine UUIDs)
const panels = engine.generatePanelsFromNodes().panels;
for (const panel of panels) {
  if (panel.source.type === 'face' && !panel.source.subAssemblyId) {
    if (panel.id !== panelId && !state.hiddenFaceIds.has(panel.id)) {
      newHiddenFaceIds.add(panel.id);
    }
  }
}
```

### Phase 3: Update BoxTree

Use engine UUIDs instead of constructed IDs:

```typescript
// Before
const outerFacePanels = faces.map((face) => ({
  id: `face-${face.id}`,
  ...
}));

// After
const outerFacePanels = faces.map((face) => {
  const panelId = panelLookup.facePanels.get(face.id);
  return {
    id: panelId ?? `open-face-${face.id}`,  // Fallback for open faces
    ...
  };
});
```

### Phase 4: Update Edge Extensions

Edge extensions are currently keyed by `face-{faceId}`. Options:

**Option A: Keep face-* keys internally, map at boundaries**
- Simpler migration
- Edge extensions stay keyed by faceId
- Map to UUID only when needed for visibility

**Option B: Migrate to UUID keys**
- More consistent
- Requires URL migration
- Better long-term

Recommendation: **Option A** for now, migrate later.

### Phase 5: Remove Legacy Compatibility

After migration:
1. Remove `MAIN_FACE_PANEL_IDS` constant
2. Remove legacy format check in `PanelPathRenderer.tsx`
3. Update all tests to use UUIDs
4. Update URL serialization (may need version bump)

---

## Challenges

### 1. Open Faces Have No Panel

When a face is open (not solid), no panel exists in the engine. Need a fallback ID for tree nodes:

```typescript
// For open faces, use a synthetic ID that won't match any real panel
const id = panelId ?? `open-${face.id}`;
```

### 2. URL Backwards Compatibility

Existing URLs have edge extensions keyed by `face-front`. Options:
- Add URL version and migrate on load
- Support both formats during transition period

### 3. Panel IDs Change on Scene Clone

During preview operations, the scene is cloned and panels get new UUIDs. This could break selection/visibility during preview.

Solution: The engine already handles this by caching panel IDs on nodes (see `CLAUDE.md` Panel ID System section).

---

## Files to Modify

| File | Changes |
|------|---------|
| `src/types.ts` | Deprecate/remove `MAIN_FACE_PANEL_IDS` |
| `src/store/useBoxStore.ts` | Update visibility functions to use engine UUIDs |
| `src/components/BoxTree.tsx` | Use engine panel lookup |
| `src/components/PanelPathRenderer.tsx` | Remove legacy format check |
| `src/engine/nodes/BaseAssembly.ts` | Consider UUID keys for edge extensions |
| `src/utils/urlState.ts` | Handle migration of legacy URLs |
| Various test files | Update to use UUIDs |

---

## Implementation Order

1. **Add lookup helpers** (non-breaking)
2. **Update BoxTree** to prefer UUIDs with legacy fallback
3. **Update visibility system** to iterate engine panels
4. **Update tests** incrementally
5. **Remove legacy code** once stable

---

## Verification

1. All visibility operations (hide/show/isolate) work with UUIDs
2. Edge extensions still work (kept on faceId keys for now)
3. Old URLs still load correctly
4. Preview/commit cycles don't break selection
5. Sub-assembly panel visibility works
